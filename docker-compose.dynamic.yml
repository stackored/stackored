services:

  mysql:
    image: "mysql:8.0"
    container_name: "stackored-mysql"
    restart: unless-stopped

    environment:
      MYSQL_ROOT_PASSWORD: "root"
      MYSQL_DATABASE: "stackored"
      MYSQL_USER: "stackored"
      MYSQL_PASSWORD: "stackored"

    volumes:
      - stackored-mysql-data:/var/lib/mysql
      - ./core/templates/database/mysql/my.cnf:/etc/mysql/conf.d/stackored.cnf:ro

    command: >
      mysqld
      --character-set-server=utf8mb4
      --collation-server=utf8mb4_unicode_ci
      --skip-character-set-client-handshake

    ports:
    - "3306:3306"

    networks:
    - stackored-net



  mariadb:
    image: "mariadb:10.6"
    container_name: "stackored-mariadb"
    restart: unless-stopped

    environment:
      MARIADB_ROOT_PASSWORD: "root"
      MARIADB_DATABASE: "stackored"
      MARIADB_USER: "stackored"
      MARIADB_PASSWORD: "stackored"

    volumes:
      - stackored-mariadb-data:/var/lib/mysql
      - ./core/templates/database/mariadb/my.cnf:/etc/mysql/conf.d/stackored.cnf:ro

    command: >
      mariadbd
      --character-set-server=utf8mb4
      --collation-server=utf8mb4_unicode_ci

    ports:
      - "3307:3306"

    networks:
      - stackored-net



  postgres:
    image: "postgres:14"
    container_name: "stackored-postgres"
    restart: unless-stopped

    environment:
      POSTGRES_DB: "stackored"
      POSTGRES_USER: "stackored"
      POSTGRES_PASSWORD: "root"
      PGDATA: "/var/lib/postgresql/data/pgdata"

    volumes:
      - stackored-postgres-data:/var/lib/postgresql/data/pgdata

    ports:
      - "5433:5432"

    networks:
      - stackored-net



  mongo:
    image: "mongo:5.0"
    container_name: "stackored-mongo"
    restart: unless-stopped

    environment:
      MONGO_INITDB_ROOT_USERNAME: "root"
      MONGO_INITDB_ROOT_PASSWORD: "root"
      MONGO_INITDB_DATABASE: "stackored"

    volumes:
      - stackored-mongo-data:/data/db
      - ./core/templates/database/mongo/mongo.conf:/etc/mongo/mongo.conf:ro

    ports:
      - "27017:27017"

    networks:
      - stackored-net



  redis:
    image: "redis:7.0"
    container_name: "stackored-redis"
    restart: unless-stopped

    command: ["redis-server", "/etc/redis/redis.conf"]

    volumes:
      - stackored-redis-data:/data
      - ./core/templates/cache/redis/redis.conf:/etc/redis/redis.conf:ro

    ports:
      - "6379:6379"

    networks:
      - stackored-net



  memcached:
    image: "memcached:1.6"
    container_name: "stackored-memcached"
    restart: unless-stopped

    command: >
      memcached
      -m 256
      -c 1024
      -t 4
      {{ MEMCACHED_EXTRA_ARGS | default('') }}

    ports:
      - "11211:11211"

    networks:
      - stackored-net


  rabbitmq:
    image: "rabbitmq:3-management"
    container_name: "stackored-rabbitmq"
    restart: unless-stopped

    environment:
      RABBITMQ_DEFAULT_USER: "admin"
      RABBITMQ_DEFAULT_PASS: "admin"
      RABBITMQ_DEFAULT_VHOST: "/"

    volumes:
      - stackored-rabbitmq-data:/var/lib/rabbitmq
      - stackored-rabbitmq-logs:/var/log/rabbitmq

    ports:
      - "5672:5672"
      - "15672:15672"

    networks:
      - stackored-net


    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.rabbitmq.rule=Host(`rabbitmq.stackored.loc`)"
      - "traefik.http.routers.rabbitmq.service=rabbitmq"
      - "traefik.http.routers.rabbitmq.entrypoints=websecure"
      - "traefik.http.services.rabbitmq.loadbalancer.server.port=15672"
      - "traefik.http.routers.rabbitmq.tls=true"


  kafbat-ui:
    image: "ghcr.io/kafbat/kafka-ui:latest"
    container_name: "stackored-kafbat"
    restart: unless-stopped

    environment:
      DYNAMIC_CONFIG_ENABLED: "true"
      KAFKA_CLUSTERS_0_NAME: "stackored-kafka"
      KAFKA_CLUSTERS_0_BOOTSTRAPSERVERS: "stackored-kafka:9092"

    ports:
      - "8080:8080"

    networks:
      - stackored-net

    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.kafbat-ui.rule=Host(`kafbat.stackored.loc`)"
      - "traefik.http.routers.kafbat-ui.service=kafbat-ui"
      - "traefik.http.routers.kafbat-ui.entrypoints=websecure"
      - "traefik.http.services.kafbat-ui.loadbalancer.server.port=8080"
      - "traefik.http.routers.kafbat-ui.tls=true"


  activemq:
    image: "apache/activemq-classic:latest"
    container_name: "stackored-activemq"
    restart: unless-stopped

    environment:
      ACTIVEMQ_ADMIN_LOGIN: "admin"
      ACTIVEMQ_ADMIN_PASSWORD: "admin"

    ports:
      - "61616:61616"
      - "5673:5672"
      - "61613:61613"
      - "1883:1883"
      - "61614:61614"
      - "8161:8161"

    volumes:
      - stackored-activemq-data:/opt/apache-activemq/data
      - stackored-activemq-conf:/opt/apache-activemq/conf

    networks:
      - stackored-net


    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.activemq.rule=Host(`activemq.stackored.loc`)"
      - "traefik.http.routers.activemq.service=activemq"
      - "traefik.http.routers.activemq.entrypoints=websecure"
      - "traefik.http.services.activemq.loadbalancer.server.port=8161"
      - "traefik.http.routers.activemq.tls=true"


  elasticsearch:
    image: "docker.elastic.co/elasticsearch/elasticsearch:8.11.3"
    container_name: "stackored-elasticsearch"
    restart: unless-stopped

    environment:
      - discovery.type=single-node
      - ES_JAVA_OPTS=-Xms1g -Xmx1g
      - xpack.security.enabled=false
      - xpack.security.enrollment.enabled=false
      - cluster.name=stackored-es
      - network.host=0.0.0.0

    ulimits:
      memlock:
        soft: -1
        hard: -1

    volumes:
      - stackored-elasticsearch-data:/usr/share/elasticsearch/data

    ports:
      - "9200:9200"

    networks:
      - stackored-net



  meilisearch:
    image: "getmeili/meilisearch:latest"
    container_name: "stackored-meilisearch"
    restart: unless-stopped

    environment:
      MEILI_MASTER_KEY: "stackored-master-key-change-me"
      MEILI_ENV: "development"
      MEILI_NO_ANALYTICS: "true"

    ports:
      - "7700:7700"

    volumes:
      - stackored-meili-data:/meili_data

    networks:
      - stackored-net


    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.meilisearch.rule=Host(`meilisearch.stackored.loc`)"
      - "traefik.http.routers.meilisearch.service=meilisearch"
      - "traefik.http.routers.meilisearch.entrypoints=websecure"
      - "traefik.http.services.meilisearch.loadbalancer.server.port=7700"
      - "traefik.http.routers.meilisearch.tls=true"


  sonarqube:
    image: "sonarqube:latest"
    container_name: "stackored-sonarqube"
    restart: unless-stopped

    environment:
      SONAR_ES_BOOTSTRAP_CHECKS_DISABLE: "true"
      SONAR_SEARCH_JAVAADDITIONALOPTS: "-Dnode.store.allow_mmap=false"
      SONAR_WEB_JAVAOPTS: "-Xms512m -Xmx512m"
      SONARQUBE_JDBC_URL: "jdbc:postgresql://postgres/sonarqube"
      SONARQUBE_JDBC_USERNAME: "sonar"
      SONARQUBE_JDBC_PASSWORD: "sonar"

    ports:
      - "9000:9000"

    volumes:
      - stackored-sonarqube-data:/opt/sonarqube/data
      - stackored-sonarqube-extensions:/opt/sonarqube/extensions

    networks:
      - stackored-net


    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.sonarqube.rule=Host(`sonarqube.stackored.loc`)"
      - "traefik.http.routers.sonarqube.service=sonarqube"
      - "traefik.http.routers.sonarqube.entrypoints=websecure"
      - "traefik.http.services.sonarqube.loadbalancer.server.port=9000"
      - "traefik.http.routers.sonarqube.tls=true"


  grafana:
    image: "grafana/grafana:latest"
    container_name: "stackored-grafana"
    restart: unless-stopped

    environment:
      GF_SECURITY_ADMIN_USER: "admin"
      GF_SECURITY_ADMIN_PASSWORD: "admin"
      GF_INSTALL_PLUGINS: ""
      GF_SERVER_ROOT_URL: "http://grafana.stackored.stackored.loc"

    volumes:
      - stackored-grafana-data:/var/lib/grafana
      - stackored-grafana-config:/etc/grafana

    ports:
      - "3001:3000"

    networks:
      - stackored-net

    user: "1000"


    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.grafana.rule=Host(`grafana.stackored.loc`)"
      - "traefik.http.routers.grafana.service=grafana"
      - "traefik.http.routers.grafana.entrypoints=websecure"
      - "traefik.http.services.grafana.loadbalancer.server.port=3000"
      - "traefik.http.routers.grafana.tls=true"


  kibana:
    image: "kibana:8.11.3"
    container_name: "stackored-kibana"
    restart: unless-stopped

    environment:
      ELASTICSEARCH_HOSTS: "http://stackored-elasticsearch:9200"
      SERVER_NAME: "stackored-kibana"
      SERVER_HOST: "0.0.0.0"

    volumes:
      - stackored-kibana-data:/usr/share/kibana/data

    ports:
      - "5601:5601"

    networks:
      - stackored-net

    depends_on:
      - elasticsearch

    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:5601/api/status || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5


    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.kibana.rule=Host(`kibana.stackored.loc`)"
      - "traefik.http.routers.kibana.service=kibana"
      - "traefik.http.routers.kibana.entrypoints=websecure"
      - "traefik.http.services.kibana.loadbalancer.server.port=5601"
      - "traefik.http.routers.kibana.tls=true"


  sentry:
    image: "getsentry/sentry:latest"
    container_name: "stackored-sentry"
    restart: unless-stopped

    environment:
      SENTRY_SECRET_KEY: "stackored-sentry-secret-key-change-me-in-production"
      SENTRY_SINGLE_ORGANIZATION: "true"
      
      # Redis Configuration
      SENTRY_REDIS_HOST: "sentry-redis"
      SENTRY_REDIS_PORT: "6379"
      
      # PostgreSQL Configuration
      SENTRY_POSTGRES_HOST: "sentry-postgres"
      SENTRY_POSTGRES_PORT: "5432"
      SENTRY_DB_NAME: "sentry"
      SENTRY_DB_USER: "sentry"
      SENTRY_DB_PASSWORD: "sentry"

    ports:
      - "9001:9000"

    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.sentry.rule=Host(`sentry.stackored.loc`)"
      - "traefik.http.routers.sentry.service=sentry"
      - "traefik.http.routers.sentry.entrypoints=websecure"
      - "traefik.http.services.sentry.loadbalancer.server.port=9000"
      - "traefik.http.routers.sentry.tls=true"
      - "traefik.enable=true"
      - "traefik.http.routers.sentry.rule=Host(`sentry.stackored.loc`)"
      - "traefik.http.routers.sentry.service=sentry"
      - "traefik.http.routers.sentry.entrypoints=websecure"
      - "traefik.http.services.sentry.loadbalancer.server.port=9000"
      - "traefik.http.routers.sentry.tls=true"

    depends_on:
      - sentry-redis
      - sentry-postgres

    networks:
      - stackored-net

  sentry-redis:
    image: redis:7
    container_name: "stackored-sentry-redis"
    restart: unless-stopped
    networks:
      - stackored-net

  sentry-postgres:
    image: postgres:15
    container_name: "stackored-sentry-postgres"
    restart: unless-stopped
    environment:
      POSTGRES_DB: sentry
      POSTGRES_USER: sentry
      POSTGRES_PASSWORD: "sentry"
    volumes:
      - stackored-sentry-postgres-data:/var/lib/postgresql/data
    networks:
      - stackored-net



  netdata:
    image: "netdata/netdata:latest"
    container_name: "stackored-netdata"
    restart: unless-stopped

    cap_add:
      - SYS_PTRACE

    security_opt:
      - apparmor:unconfined

    ports:
      - "19999:19999"

    volumes:
      - netdata-config:/etc/netdata
      - netdata-lib:/var/lib/netdata
      - netdata-cache:/var/cache/netdata
      - /etc/passwd:/host/etc/passwd:ro
      - /etc/group:/host/etc/group:ro
      - /proc:/host/proc:ro
      - /sys:/host/sys:ro
      - /etc/os-release:/host/etc/os-release:ro

    networks:
      - stackored-net


    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.netdata.rule=Host(`netdata.stackored.loc`)"
      - "traefik.http.routers.netdata.service=netdata"
      - "traefik.http.routers.netdata.entrypoints=websecure"
      - "traefik.http.services.netdata.loadbalancer.server.port=19999"
      - "traefik.http.routers.netdata.tls=true"


  tomcat:
    image: "tomcat:latest"
    container_name: "stackored-tomcat"
    restart: unless-stopped

    volumes:
      - ./core/templates/appserver/tomcat/webapps:/usr/local/tomcat/webapps
      - stackored-tomcat-logs:/usr/local/tomcat/logs

    ports:
      - "8081:8080"

    networks:
      - stackored-net

    environment:
      CATALINA_OPTS: "-Xms512M -Xmx1024M"
      JAVA_OPTS: "-Djava.awt.headless=true"


    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.tomcat.rule=Host(`tomcat.stackored.loc`)"
      - "traefik.http.routers.tomcat.service=tomcat"
      - "traefik.http.routers.tomcat.entrypoints=websecure"
      - "traefik.http.services.tomcat.loadbalancer.server.port=8080"
      - "traefik.http.routers.tomcat.tls=true"


  kong:
    image: "kong:latest"
    container_name: "stackored-kong"
    restart: unless-stopped

    environment:
      KONG_DATABASE: "off"
      KONG_PROXY_ACCESS_LOG: "/dev/stdout"
      KONG_ADMIN_ACCESS_LOG: "/dev/stdout"
      KONG_PROXY_ERROR_LOG: "/dev/stderr"
      KONG_ADMIN_ERROR_LOG: "/dev/stderr"
      KONG_ADMIN_LISTEN: "0.0.0.0:8001"
      KONG_DECLARATIVE_CONFIG: "/kong/declarative/kong.yml"

    volumes:
      - ./core/templates/appserver/kong/kong.yml:/kong/declarative/kong.yml:ro

    ports:
      - "8000:8000"
      - "8443:8443"
      - "8001:8001"
      - "8444:8444"

    networks:
      - stackored-net

    healthcheck:
      test: ["CMD", "kong", "health"]
      interval: 10s
      timeout: 10s
      retries: 10

    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.kong.rule=Host(`kong-admin.stackored.loc`)"
      - "traefik.http.routers.kong.service=kong"
      - "traefik.http.routers.kong.entrypoints=websecure"
      - "traefik.http.services.kong.loadbalancer.server.port=8001"
      - "traefik.http.routers.kong.tls=true"


  tools:
    build:
      context: ./core/templates/ui/tools
      dockerfile: Dockerfile
    container_name: "stackored-tools"
    restart: unless-stopped

    environment:
      # Pass necessary environment variables for tools configuration
      PMA_HOST: stackored-mysql
      PMA_PORT: 3306
      PMA_ARBITRARY: 1

    networks:
      - stackored-net

    labels:
      - "traefik.enable=true"
      - "traefik.http.services.tools.loadbalancer.server.port=80"
      - "traefik.http.routers.adminer.rule=Host(`adminer.stackored.loc`)"
      - "traefik.http.routers.adminer.service=tools"
      - "traefik.http.routers.adminer.entrypoints=websecure"
      - "traefik.http.routers.adminer.tls=true"
      - "traefik.http.routers.phpmyadmin.rule=Host(`phpmyadmin.stackored.loc`)"
      - "traefik.http.routers.phpmyadmin.service=tools"
      - "traefik.http.routers.phpmyadmin.entrypoints=websecure"
      - "traefik.http.routers.phpmyadmin.tls=true"
      - "traefik.http.routers.phppgadmin.rule=Host(`phppgadmin.stackored.loc`)"
      - "traefik.http.routers.phppgadmin.service=tools"
      - "traefik.http.routers.phppgadmin.entrypoints=websecure"
      - "traefik.http.routers.phppgadmin.tls=true"
      - "traefik.http.routers.phpmongo.rule=Host(`phpmongo.stackored.loc`)"
      - "traefik.http.routers.phpmongo.service=tools"
      - "traefik.http.routers.phpmongo.entrypoints=websecure"
      - "traefik.http.routers.phpmongo.tls=true"
      - "traefik.http.routers.phpmemcachedadmin.rule=Host(`phpmemcachedadmin.stackored.loc`)"
      - "traefik.http.routers.phpmemcachedadmin.service=tools"
      - "traefik.http.routers.phpmemcachedadmin.entrypoints=websecure"
      - "traefik.http.routers.phpmemcachedadmin.tls=true"
      - "traefik.http.routers.opcache.rule=Host(`opcache.stackored.loc`)"
      - "traefik.http.routers.opcache.service=tools"
      - "traefik.http.routers.opcache.entrypoints=websecure"
      - "traefik.http.routers.opcache.tls=true"


  mailhog:
    image: "mailhog/mailhog:latest"
    container_name: "stackored-mailhog"
    restart: unless-stopped

    ports:
      - "1025:1025"
      - "8025:8025"

    networks:
      - stackored-net

    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.mailhog.rule=Host(`mailhog.stackored.loc`)"
      - "traefik.http.routers.mailhog.service=mailhog"
      - "traefik.http.routers.mailhog.entrypoints=websecure"
      - "traefik.http.services.mailhog.loadbalancer.server.port=8025"
      - "traefik.http.routers.mailhog.tls=true"


volumes:

  stackored-mysql-data:


  stackored-mariadb-data:


  stackored-postgres-data:


  stackored-mongo-data:


  stackored-redis-data:


  stackored-rabbitmq-data:
  stackored-rabbitmq-logs:


  stackored-activemq-data:
  stackored-activemq-conf:


  stackored-elasticsearch-data:


  stackored-meili-data:


  stackored-sonarqube-data:
  stackored-sonarqube-extensions:


  stackored-grafana-data:
  stackored-grafana-config:


  stackored-kibana-data:


  stackored-sentry-postgres-data:


  netdata-config:
  netdata-lib:
  netdata-cache:


  stackored-tomcat-logs:

