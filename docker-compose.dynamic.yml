services:

  mysql:
    image: "mysql:8.0"
    container_name: "stackored-mysql"
    restart: unless-stopped

    environment:
      MYSQL_ROOT_PASSWORD: "${MYSQL_ROOT_PASSWORD:-root}"
      MYSQL_DATABASE: "${MYSQL_DATABASE:-stackored}"
      MYSQL_USER: "${MYSQL_USER:-stackored}"
      MYSQL_PASSWORD: "${MYSQL_PASSWORD:-stackored}"

    volumes:
      - stackored-mysql-data:/var/lib/mysql
      - ./core/templates/database/mysql/my.cnf:/etc/mysql/conf.d/stackored.cnf:ro

    command: >
      mysqld
      --character-set-server=utf8mb4
      --collation-server=utf8mb4_unicode_ci
      --skip-character-set-client-handshake

    ports:
      - "${HOST_PORT_MYSQL:-3306}:3306"

    networks:
      - "stackored-net"


  mariadb:
    image: "mariadb:10.6"
    container_name: "stackored-mariadb"
    restart: unless-stopped

    environment:
      MARIADB_ROOT_PASSWORD: "${MARIADB_ROOT_PASSWORD:-root}"
      MARIADB_DATABASE: "${MARIADB_DATABASE:-stackored}"
      MARIADB_USER: "${MARIADB_USER:-stackored}"
      MARIADB_PASSWORD: "${MARIADB_PASSWORD:-stackored}"

    volumes:
      - stackored-mariadb-data:/var/lib/mysql
      - ./core/templates/database/mariadb/my.cnf:/etc/mysql/conf.d/stackored.cnf:ro

    command: >
      mariadbd
      --character-set-server=utf8mb4
      --collation-server=utf8mb4_unicode_ci

    ports:
      - "${HOST_PORT_MARIADB:-3307}:3306"

    networks:
      - "stackored-net"


  postgres:
    image: "postgres:14"
    container_name: "stackored-postgres"
    restart: unless-stopped

    environment:
      POSTGRES_DB: "${POSTGRES_DB:-stackored}"
      POSTGRES_USER: "${POSTGRES_USER:-stackored}"
      POSTGRES_PASSWORD: "${POSTGRES_PASSWORD:-stackored}"
      PGDATA: "/var/lib/postgresql/data/pgdata"

    volumes:
      - stackored-postgres-data:/var/lib/postgresql/data/pgdata

    ports:
      - "${HOST_PORT_POSTGRES:-5432}:5432"

    networks:
      - "stackored-net"


  mongo:
    image: "mongo:5.0"
    container_name: "stackored-mongo"
    restart: unless-stopped

    environment:
      MONGO_INITDB_ROOT_USERNAME: "${MONGO_USER:-root}"
      MONGO_INITDB_ROOT_PASSWORD: "${MONGO_PASSWORD:-root}"
      MONGO_INITDB_DATABASE: "${MONGO_DATABASE:-stackored}"

    volumes:
      - stackored-mongo-data:/data/db
      - ./core/templates/database/mongo/mongo.conf:/etc/mongo/mongo.conf:ro

    ports:
      - "${HOST_PORT_MONGO:-27017}:27017"

    networks:
      - "stackored-net"


  redis:
    image: "redis:7.0"
    container_name: "stackored-redis"
    restart: unless-stopped

    command: ["redis-server", "/etc/redis/redis.conf"]

    volumes:
      - stackored-redis-data:/data
      - ./core/templates/cache/redis/redis.conf:/etc/redis/redis.conf:ro

    ports:
      - "${HOST_PORT_REDIS:-6379}:6379"

    networks:
      - "stackored-net"


  memcached:
    image: "memcached:1.6"
    container_name: "stackored-memcached"
    restart: unless-stopped

    command: >
      memcached
      -m ${MEMCACHED_MEMORY:-256}
      -c ${MEMCACHED_CONNECTIONS:-1024}
      -t ${MEMCACHED_THREADS:-4}
      ${MEMCACHED_EXTRA_ARGS:-}

    ports:
      - "${HOST_PORT_MEMCACHED:-11211}:11211"

    networks:
      - "stackored-net"

  rabbitmq:
    image: "rabbitmq:3-management"
    container_name: "stackored-rabbitmq"
    restart: unless-stopped

    environment:
      RABBITMQ_DEFAULT_USER: "admin"
      RABBITMQ_DEFAULT_PASS: "admin"
      RABBITMQ_DEFAULT_VHOST: "/"

    volumes:
      - stackored-rabbitmq-data:/var/lib/rabbitmq
      - stackored-rabbitmq-logs:/var/log/rabbitmq

    ports:
      - "${HOST_PORT_RABBITMQ:-5672}:5672"
      - "${HOST_PORT_RABBITMQ_MGMT:-15672}:15672"

    networks:
      - "stackored-net"


  kafbat-ui:
    image: "ghcr.io/kafbat/kafka-ui:latest"
    container_name: "stackored-kafbat"
    restart: unless-stopped

    environment:
      DYNAMIC_CONFIG_ENABLED: "true"
      KAFKA_CLUSTERS_0_NAME: "${KAFBAT_CLUSTER_NAME:-stackored-kafka}"
      KAFKA_CLUSTERS_0_BOOTSTRAPSERVERS: "${KAFBAT_KAFKA_BOOTSTRAP:-stackored-kafka:9092}"

    ports:
      - "${HOST_PORT_KAFBAT:-8080}:8080"

    networks:
      - "stackored-net"

  activemq:
    image: "apache/activemq-classic:latest"
    container_name: "stackored-activemq"
    restart: unless-stopped

    environment:
      ACTIVEMQ_ADMIN_LOGIN: "admin"
      ACTIVEMQ_ADMIN_PASSWORD: "admin"

    ports:
      - "${HOST_PORT_ACTIVEMQ_OPENWIRE:-61616}:61616"
      - "${HOST_PORT_ACTIVEMQ_AMQP:-5672}:5672"
      - "${HOST_PORT_ACTIVEMQ_STOMP:-61613}:61613"
      - "${HOST_PORT_ACTIVEMQ_MQTT:-1883}:1883"
      - "${HOST_PORT_ACTIVEMQ_WS:-61614}:61614"
      - "${HOST_PORT_ACTIVEMQ_UI:-8161}:8161"

    volumes:
      - stackored-activemq-data:/opt/apache-activemq/data
      - stackored-activemq-conf:/opt/apache-activemq/conf

    networks:
      - "stackored-net"


  elasticsearch:
    image: "docker.elastic.co/elasticsearch/elasticsearch:8.11.3"
    container_name: "stackored-elasticsearch"
    restart: unless-stopped

    environment:
      - discovery.type=single-node
      - ES_JAVA_OPTS=${ES_JAVA_OPTS:--Xms1g -Xmx1g}
      - xpack.security.enabled=${ELASTIC_SECURITY:-false}
      - xpack.security.enrollment.enabled=${ELASTIC_ENROLLMENT:-false}
      - cluster.name=stackored-es
      - network.host=0.0.0.0

    ulimits:
      memlock: -1
      nofile: 65536

    volumes:
      - stackored-elasticsearch-data:/usr/share/elasticsearch/data

    ports:
      - "${HOST_PORT_ELASTICSEARCH:-9200}:9200"

    networks:
      - "stackored-net"


  meilisearch:
    image: "getmeili/meilisearch:latest"
    container_name: "stackored-meilisearch"
    restart: unless-stopped

    environment:
      MEILI_MASTER_KEY: "${MEILISEARCH_MASTER_KEY:-stackored-master-key}"
      MEILI_ENV: "development"
      MEILI_NO_ANALYTICS: "true"

    ports:
      - "${HOST_PORT_MEILISEARCH:-7700}:7700"

    volumes:
      - stackored-meili-data:/meili_data

    networks:
      - "stackored-net"


  kibana:
    image: "kibana:8.11.3"
    container_name: "stackored-kibana"
    restart: unless-stopped

    environment:
      ELASTICSEARCH_HOSTS: "${KIBANA_ELASTICSEARCH_HOSTS:-http://stackored-elasticsearch:9200}"
      SERVER_NAME: "${KIBANA_SERVER_NAME:-stackored-kibana}"
      SERVER_HOST: "${KIBANA_SERVER_HOST:-0.0.0.0}"

    volumes:
      - stackored-kibana-data:/usr/share/kibana/data

    ports:
      - "${HOST_PORT_KIBANA:-5601}:5601"

    networks:
      - "stackored-net"

    depends_on:
      - elasticsearch

    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:5601/api/status || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5


  grafana:
    image: "grafana/grafana:latest"
    container_name: "stackored-grafana"
    restart: unless-stopped

    environment:
      GF_SECURITY_ADMIN_USER: "admin"
      GF_SECURITY_ADMIN_PASSWORD: "admin"
      GF_INSTALL_PLUGINS: ""
      GF_SERVER_ROOT_URL: "http://grafana.stackored.${DEFAULT_TLD_SUFFIX:-loc}"

    volumes:
      - stackored-grafana-data:/var/lib/grafana
      - stackored-grafana-config:/etc/grafana

    ports:
      - "${HOST_PORT_GRAFANA:-3001}:3000"

    networks:
      - "stackored-net"

    user: "${HOST_USER_ID:-472}"


  netdata:
    image: "netdata/netdata:latest"
    container_name: "stackored-netdata"
    restart: unless-stopped

    cap_add:
      - SYS_PTRACE

    security_opt:
      - apparmor:unconfined

    ports:
      - "${HOST_PORT_NETDATA:-19999}:19999"

    volumes:
      - netdata-config:/etc/netdata
      - netdata-lib:/var/lib/netdata
      - netdata-cache:/var/cache/netdata
      - /etc/passwd:/host/etc/passwd:ro
      - /etc/group:/host/etc/group:ro
      - /proc:/host/proc:ro
      - /sys:/host/sys:ro
      - /etc/os-release:/host/etc/os-release:ro

    networks:
      - "stackored-net"


  sonarqube:
    image: "sonarqube:latest"
    container_name: "stackored-sonarqube"
    restart: unless-stopped

    environment:
      SONAR_ES_BOOTSTRAP_CHECKS_DISABLE: "true"
      SONAR_SEARCH_JAVAADDITIONALOPTS: "-Dnode.store.allow_mmap=false"
      SONAR_WEB_JAVAOPTS: "${SONARQUBE_JAVA_OPTS:--Xms512m -Xmx512m}"
      SONARQUBE_JDBC_URL: "${SONARQUBE_JDBC_URL:-jdbc:postgresql://postgres/sonarqube}"
      SONARQUBE_JDBC_USERNAME: "${SONARQUBE_DB_USERNAME:-sonar}"
      SONARQUBE_JDBC_PASSWORD: "${SONARQUBE_DB_PASSWORD:-sonar}"

    ports:
      - "${HOST_PORT_SONARQUBE:-9000}:9000"

    volumes:
      - stackored-sonarqube-data:/opt/sonarqube/data
      - stackored-sonarqube-extensions:/opt/sonarqube/extensions

    networks:
      - "stackored-net"


  sentry:
    image: "getsentry/sentry:latest"
    container_name: "stackored-sentry"
    restart: unless-stopped

    environment:
      SENTRY_SECRET_KEY: "${SENTRY_SECRET_KEY:-stackored-sentry-secret-key-change-me}"
      SENTRY_SINGLE_ORGANIZATION: "true"
      
      # Redis Configuration
      SENTRY_REDIS_HOST: "sentry-redis"
      SENTRY_REDIS_PORT: "6379"
      
      # PostgreSQL Configuration
      SENTRY_POSTGRES_HOST: "sentry-postgres"
      SENTRY_POSTGRES_PORT: "5432"
      SENTRY_DB_NAME: "sentry"
      SENTRY_DB_USER: "sentry"
      SENTRY_DB_PASSWORD: "${SENTRY_DB_PASSWORD:-sentry}"

    ports:
      - "${HOST_PORT_SENTRY:-9001}:9000"

    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.sentry.rule=Host(`sentry.stackored.loc`)"
      - "traefik.http.routers.sentry.service=sentry"
      - "traefik.http.routers.sentry.entrypoints=websecure"
      - "traefik.http.services.sentry.loadbalancer.server.port=9000"
      - "traefik.http.routers.sentry.tls=true"

    depends_on:
      - sentry-redis
      - sentry-postgres

    networks:
      - "stackored-net"

  sentry-redis:
    image: redis:7
    container_name: "stackored-sentry-redis"
    restart: unless-stopped
    networks:
      - "stackored-net"

  sentry-postgres:
    image: postgres:15
    container_name: "stackored-sentry-postgres"
    restart: unless-stopped
    environment:
      POSTGRES_DB: sentry
      POSTGRES_USER: sentry
      POSTGRES_PASSWORD: "${SENTRY_DB_PASSWORD:-sentry}"
    volumes:
      - stackored-sentry-postgres-data:/var/lib/postgresql/data
    networks:
      - "stackored-net"


  tomcat:
    image: "tomcat:latest"
    container_name: "stackored-tomcat"
    restart: unless-stopped

    volumes:
      - ./core/templates/appserver/tomcat/webapps:/usr/local/tomcat/webapps
      - stackored-tomcat-logs:/usr/local/tomcat/logs

    ports:
      - "${HOST_PORT_TOMCAT:-8080}:8080"

    networks:
      - "stackored-net"

    environment:
      CATALINA_OPTS: "${TOMCAT_CATALINA_OPTS:--Xms512M -Xmx1024M}"
      JAVA_OPTS: "${TOMCAT_JAVA_OPTS:--Djava.awt.headless=true}"


  kong:
    image: "kong:latest"
    container_name: "stackored-kong"
    restart: unless-stopped

    environment:
      KONG_DATABASE: "${KONG_DATABASE:-off}"
      KONG_PROXY_ACCESS_LOG: "/dev/stdout"
      KONG_ADMIN_ACCESS_LOG: "/dev/stdout"
      KONG_PROXY_ERROR_LOG: "/dev/stderr"
      KONG_ADMIN_ERROR_LOG: "/dev/stderr"
      KONG_ADMIN_LISTEN: "${KONG_ADMIN_LISTEN:-0.0.0.0:8001}"
      KONG_DECLARATIVE_CONFIG: "/kong/declarative/kong.yml"

    volumes:
      - ./core/templates/appserver/kong/kong.yml:/kong/declarative/kong.yml:ro

    ports:
      - "${HOST_PORT_KONG_PROXY:-8000}:8000"
      - "${HOST_PORT_KONG_PROXY_SSL:-8443}:8443"
      - "${HOST_PORT_KONG_ADMIN:-8001}:8001"
      - "${HOST_PORT_KONG_ADMIN_SSL:-8444}:8444"

    networks:
      - "stackored-net"

    healthcheck:
      test: ["CMD", "kong", "health"]
      interval: 10s
      timeout: 10s
      retries: 10

  mailhog:
    image: "mailhog/mailhog:latest"
    container_name: "stackored-mailhog"
    restart: unless-stopped

    ports:
      - "${HOST_PORT_MAILHOG_SMTP:-1025}:1025"
      - "${HOST_PORT_MAILHOG_UI:-8025}:8025"

    networks:
      - "stackored-net"

  tools:
    build:
      context: ./core/templates/ui/tools
      dockerfile: Dockerfile
    container_name: "stackored-tools"
    restart: unless-stopped

    environment:
      # Pass necessary environment variables for tools configuration
      PMA_HOST: stackored-mysql
      PMA_PORT: 3306
      PMA_ARBITRARY: 1

    networks:
      - "stackored-net"


volumes:
  netdata-cache: {}
  netdata-config: {}
  netdata-lib: {}
  stackored-activemq-conf: {}
  stackored-activemq-data: {}
  stackored-cassandra-data: {}
  stackored-composer-cache: {}
  stackored-couchbase-data: {}
  stackored-couchdb-config: {}
  stackored-couchdb-data: {}
  stackored-elasticsearch-data: {}
  stackored-grafana-config: {}
  stackored-grafana-data: {}
  stackored-kafka-data: {}
  stackored-kibana-data: {}
  stackored-logstash-data: {}
  stackored-mariadb-data: {}
  stackored-meili-data: {}
  stackored-mongo-data: {}
  stackored-mysql-data: {}
  stackored-nats-data: {}
  stackored-node-modules: {}
  stackored-percona-data: {}
  stackored-postgres-data: {}
  stackored-rabbitmq-data: {}
  stackored-rabbitmq-logs: {}
  stackored-redis-data: {}
  stackored-sentry-postgres-data: {}
  stackored-solr-data: {}
  stackored-sonarqube-data: {}
  stackored-sonarqube-extensions: {}
  stackored-tomcat-logs: {}
