# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Overview

Stackored is a Docker-based development environment orchestration system that uses Traefik as a reverse proxy and a shell-based generator to create dynamic Docker Compose configurations. The system runs without PHP dependencies and manages multiple projects with different PHP versions, databases, and services.

## Core Architecture

### Three-Layer Compose System

1. **stackored.yml** (Base Layer)
   - Generated by `cli/generate.sh`
   - Contains Traefik reverse proxy and the stackored-net network
   - Network configuration: 172.30.0.0/16 subnet with gateway at 172.30.0.1

2. **docker-compose.dynamic.yml** (Services Layer)
   - Generated dynamically based on .env flags (MYSQL_ENABLE, REDIS_ENABLE, etc.)
   - Contains infrastructure services (databases, cache, message queues, monitoring)
   - All services connect to external stackored-net network

3. **docker-compose.projects.yml** (Projects Layer)
   - Contains PHP project containers (php-fpm + nginx pairs)
   - Each project defined by stackored.json configuration
   - Automatically routed through Traefik using domain labels

### Generator System

The `cli/generate.sh` shell script is the core engine:
- Reads `.env` configuration
- Uses `is_enabled()` function to check ENABLE_* flags
- Generates both stackored.yml and docker-compose.dynamic.yml
- Creates Docker network if not exists
- Simple template variable replacement ({{ VARIABLE }} pattern)

### Project Configuration

Each project in `projects/` directory requires:
- **stackored.json**: Project metadata (domain, PHP version, webserver, document_root)
- **nginx.conf**: Custom Nginx configuration (auto-generated if missing)
- PHP-FPM and Nginx containers are created as pairs (project-php and project-web)

### Traefik Routing

- HTTP entrypoint on port 80 (redirects to HTTPS if configured)
- HTTPS entrypoint on port 443
- Dashboard on port 8080 (insecure mode)
- Dynamic configuration loaded from `core/traefik/dynamic/*.yml`
- Projects routed via Host() rules in labels
- SSL/TLS controlled by TRAEFIK_ENABLE_SSL in .env

## Common Commands

### Core Operations
```bash
./cli/stackored generate    # Generate compose files from .env
./cli/stackored up          # Start all services (base + dynamic + projects)
./cli/stackored down        # Stop all services
./cli/stackored restart     # Restart all services
./cli/stackored ps          # List running containers
./cli/stackored logs [srv]  # View logs (optionally filter by service)
./cli/stackored doctor      # System health check
```

### Development Workflow
```bash
# 1. Modify .env to enable/disable services
# 2. Regenerate compose files
./cli/stackored generate

# 3. Restart to apply changes
./cli/stackored down && ./cli/stackored up

# 4. Check service status
./cli/stackored ps
```

### Adding New Services

1. Add ENABLE_* and configuration variables to .env
2. Update `cli/generate.sh` with new service block in the conditional section (around line 245-390)
3. Follow existing pattern: check `is_enabled`, append to docker-compose.dynamic.yml
4. Add volume declaration if service needs persistent data

## Configuration System

### Environment Variables (.env)

The .env file is organized into sections:
- **TRAEFIK SETTINGS**: Domain suffix, SSL, Let's Encrypt
- **DATABASES**: MySQL, MariaDB, PostgreSQL, MongoDB, Cassandra, Percona, CouchDB, Couchbase
- **CACHING**: Redis, Memcached
- **MESSAGE QUEUES**: RabbitMQ, NATS, Kafka, ActiveMQ
- **SEARCH**: Elasticsearch, Kibana, Solr, Meilisearch, Logstash
- **MONITORING**: SonarQube, Grafana, Sentry
- **ADMIN TOOLS**: Adminer, PhpMyAdmin, PhpPgAdmin, PhpMongo
- **DEVELOPMENT**: MailHog, Composer, Ngrok, Blackfire, Selenium, Netdata
- **APP SERVERS**: Tomcat, Kong

### Service Enabling Pattern
```bash
# Set to "true" (case-insensitive) to enable
MYSQL_ENABLE=true
MYSQL_VERSION=8.0
MYSQL_ROOT_PASSWORD=root
```

The generator's `is_enabled()` function checks the *_ENABLE variables.

## Template System

Templates are located in `core/templates/` organized by category:
- `database/`: MySQL, PostgreSQL, MongoDB, etc.
- `cache/`: Redis, Memcached
- `messaging/`: RabbitMQ, Kafka, ActiveMQ
- `search/`: Elasticsearch, Solr
- `monitoring/`: Grafana, Kibana
- `ui/`: PhpMyAdmin, Adminer, admin interfaces
- `appserver/`: Kong, Tomcat

Template files use {{ VARIABLE }} placeholder syntax for variable substitution.

## Network Architecture

All services share a single Docker bridge network:
- **Network name**: stackored-net
- **Subnet**: 172.30.0.0/16
- **Gateway**: 172.30.0.1
- **ICC enabled**: true (inter-container communication)
- **Created externally**: Must exist before docker-compose up

## Project Structure Conventions

```
projects/
  project-name/
    stackored.json       # Project configuration
    nginx.conf           # Nginx server config
    public/              # Document root (default)
    (application files)
```

The generator reads stackored.json to:
- Determine PHP version for php-fpm image
- Set Traefik routing domain
- Configure webserver type (nginx/apache)
- Set document root path

## CLI Extension Points

The `cli/stackored` router script handles:
- `generate`: Runs generator script
- `up/down/restart/ps/logs`: Docker compose operations using all three compose files
- `doctor`: System diagnostics (if script exists)
- `project create`: Project scaffolding (requires PHP for now)

All compose commands use the -f flag with three files in order:
1. stackored.yml
2. docker-compose.dynamic.yml
3. docker-compose.projects.yml

## Important Implementation Notes

### Generator Behavior
- The generator always creates network if missing (line 427)
- Volumes are only added to compose file if data services are enabled (lines 404-421)
- Project nginx.conf is auto-created with placeholder for fastcgi_pass (PROJECT_NAME)
- The sed command for nginx.conf uses `sed -i ''` (line 233) which is macOS syntax

### Path Handling
- STACKORED_ROOT dynamically determined from script location
- Project paths in docker-compose.projects.yml are absolute (needs fixing for portability)
- Template paths are relative to ROOT_DIR

### Docker Compose v3.9
All compose files use version: "3.9" specification.

## Access Points

Once running, services are accessible at:
- **Traefik Dashboard**: http://localhost:8080
- **Projects**: http://project-name.stackored.loc (or custom domain from stackored.json)
- **Database Tools**: http://phpmyadmin.stackored.loc, http://adminer.stackored.loc
- **Monitoring**: http://grafana.stackored.loc, http://kibana.stackored.loc

Requires /etc/hosts entries for *.stackored.loc domains pointing to 127.0.0.1.

## Troubleshooting Checklist

1. **Services not starting**: Check stackored-net network exists (`docker network ls`)
2. **Routing not working**: Verify Traefik labels on containers (`docker inspect`)
3. **Port conflicts**: Check ports 80, 443, 8080 are available
4. **Generation fails**: Verify .env syntax and ENABLE_* variables
5. **Projects not accessible**: Check /etc/hosts entries and stackored.json domain configuration
