###################################################################
# TRAEFIK - GLOBAL CONFIGURATION (STACKORED CORE)
###################################################################

api:
  dashboard: true
  insecure: false # dashboard only via secure entryPoint

###################################################################
# ENTRYPOINTS
###################################################################
entryPoints:
  web:
    address: ":80"
    http:
      redirections:
        entryPoint:
          to: websecure
          scheme: https
          permanent: true

  websecure:
    address: ":443"

###################################################################
# LOGGING
###################################################################
log:
  level: INFO

accessLog:
  bufferingSize: 100

###################################################################
# CERTIFICATES (Optional)
###################################################################
# If STACKORED_ENABLE_LETSENCRYPT=true is set in env, this can be activated
certificatesResolvers:
  letsencrypt:
    acme:
      email: "admin@stackored.local"
      storage: "/etc/traefik/acme.json"
      httpChallenge:
        entryPoint: web

###################################################################
# PROVIDERS (STATIC + DYNAMIC)
###################################################################
providers:
  file:
    directory: "/etc/traefik/dynamic"
    watch: true

  docker:
    endpoint: "unix:///var/run/docker.sock"
    watch: true
    exposedByDefault: false

###################################################################
# MIDDLEWARES (GLOBAL)
###################################################################

# Force HTTPS everywhere (already handled by entrypoint, but middleware allows per-router control)
http:
  middlewares:
    redirect-to-https:
      redirectScheme:
        scheme: https
        permanent: true

    security-headers:
      headers:
        frameDeny: true
        sslRedirect: true
        contentTypeNosniff: true
        browserXssFilter: true
        referrerPolicy: "same-origin"
        forceSTSHeader: true
        stsSeconds: 31536000
        stsIncludeSubdomains: true
        stsPreload: true

  ###################################################################
  # GLOBAL ROUTERS (OPTIONAL)
  ###################################################################

  # Main dashboard access route
  routers:
    traefik-dashboard:
      rule: "Host(`traefik.localhost`) || Host(`traefik.stackored`)"
      entryPoints:
        - websecure
      tls:
        certResolver: letsencrypt
      service: api@internal
      middlewares:
        - security-headers
